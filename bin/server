#! /usr/bin/env ruby

$:.unshift(File.expand_path('../../lib', __FILE__))

require 'eventmachine'
require 'thin'

require File.expand_path('../../config', __FILE__)
require 'app'
require 'web_socket'

def start
  host = '0.0.0.0'

  EventMachine.run do
    WebSocket.run! :port => WEB_SOCKET_PORT

    server = Thin::Server.new(host, APP_PORT) do
      run App
    end

    server.pid_file = PID_FILE
    server.log_file = LOG_FILE
  
    if DAEMONIZE
      puts ">> bulb server listening on #{host}:#{APP_PORT}" if DAEMONIZE
      server.daemonize
    end

    server.start
  end
end

def stop
  Thin::Server.kill(PID_FILE)
end

def restart
  Thin::Server.restart(PID_FILE)
end

case ARGV[0]
when 'start'    then start
when 'stop'     then stop
when 'restart'  then restart
else
  puts "Usage: #{$0} start|stop|restart"
end

